# Implementation Plan: Configuration Schema and Validation (Issue #206)

## Overview

Add JSON schema generation for `.agnix.toml` configuration files using schemars, implement semantic validation with helpful errors, create a CLI subcommand for schema generation, and prepare for schemastore.org submission. The VS Code extension will be updated with schema associations for autocomplete support.

## Architecture

Use schemars crate (already used in agnix-mcp) to derive JSON Schema from LintConfig and related types in agnix-core. Add a `validate()` method to LintConfig for semantic validation beyond TOML parsing. Create `agnix schema` CLI subcommand that outputs the JSON schema. Store the generated schema in the repository for schemastore.org submission and VS Code integration.

---

## Implementation Steps

### Step 1: Add schemars dependency and derive JsonSchema on config types

**Goal**: Enable JSON schema generation from Rust types

**Files**:
- `crates/agnix-core/Cargo.toml` - Add schemars dependency
- `crates/agnix-core/src/config.rs` - Add JsonSchema derive and descriptions

**Details**:
- Add `schemars = { version = "0.8", features = ["derive"] }` to agnix-core
- Add `#[derive(JsonSchema)]` to LintConfig, RuleConfig, ToolVersions, SpecRevisions, SeverityLevel, TargetTool
- Add `#[schemars(skip)]` to runtime-only fields (root_dir, import_cache, runtime)
- Add `#[schemars(description = "...")]` with helpful descriptions to all fields

---

### Step 2: Add schema generation function to agnix-core

**Goal**: Expose a function to generate the JSON schema programmatically

**Files**:
- `crates/agnix-core/src/config.rs` - Add generate_schema() function
- `crates/agnix-core/src/lib.rs` - Re-export the function

**Details**:
- Add `generate_schema()` function returning `schemars::schema_for!(LintConfig)`
- Set `$id` to `https://json.schemastore.org/agnix.json` for schemastore compatibility

---

### Step 3: Implement semantic validation for config

**Goal**: Validate config values beyond type correctness with helpful error messages

**Files**:
- `crates/agnix-core/src/config.rs` - Add validate() method

**Details**:
- Create `ConfigError` struct with field, message, suggestion
- Add `LintConfig::validate(&self) -> Vec<ConfigError>` method
- Validate rule IDs in `disabled_rules` match known patterns (AS-*, CC-*, MCP-*, etc.)
- Validate tool names in `tools` array match known tools
- Warn on deprecated fields (e.g., `mcp_protocol_version`)

---

### Step 4: Update CLI to report validation errors

**Goal**: Show helpful validation errors when config has semantic issues

**Files**:
- `crates/agnix-cli/src/main.rs` - Call validate() and display errors

**Details**:
- After `load_or_default()`, invoke `config.validate()`
- Display warnings in yellow, errors in red
- Continue if only warnings, exit on errors

---

### Step 5: Add `agnix schema` CLI subcommand

**Goal**: Allow users to generate and output the JSON schema

**Files**:
- `crates/agnix-cli/src/main.rs` - Add Schema subcommand

**Details**:
- Add `Schema` variant to Commands enum
- Default: print schema to stdout
- `--output` flag to write to file
- Example usage: `agnix schema > agnix.json`

---

### Step 6: Generate and commit schema file

**Goal**: Store the canonical schema in the repository for distribution

**Files**:
- `schemas/agnix.json` - Generated JSON schema (new)
- `schemas/README.md` - Schema documentation (new)

**Details**:
- Create `schemas/` directory at repository root
- Generate `agnix.json` using the schema command
- Add CI check to verify schema stays in sync

---

### Step 7: Update VS Code extension with schema association

**Goal**: Enable autocomplete and validation for .agnix.toml in VS Code

**Files**:
- `editors/vscode/package.json` - Add schema contribution

**Details**:
- Add `contributes.jsonValidation` for `.agnix.toml` files
- Associate with bundled schema or schemastore URL
- Works with Even Better TOML extension

---

### Step 8: Improve config auto-discovery

**Goal**: Support finding .agnix.toml in parent directories

**Files**:
- `crates/agnix-cli/src/main.rs` - Enhance resolve_config_path()
- `crates/agnix-core/src/config.rs` - Add find_config() function

**Details**:
- Search current directory first
- Walk up to repo root (.git directory)
- Check global config (~/.config/agnix/config.toml)
- Merge global with project config

---

### Step 9: Prepare schemastore.org submission

**Goal**: Create documentation for schemastore submission

**Files**:
- `schemas/SCHEMASTORE.md` - Submission instructions (new)

**Details**:
- Document schemastore.org submission process
- Create catalog entry JSON template
- Reference fileMatch patterns: `.agnix.toml`, `agnix.toml`

---

### Step 10: Add comprehensive tests

**Goal**: Ensure schema generation and validation work correctly

**Files**:
- `crates/agnix-core/src/config.rs` - Unit tests
- `tests/cli_tests.rs` - Integration tests
- `tests/fixtures/config_validation/` - Test fixtures (new)

**Details**:
- Test schema generates valid JSON
- Test validation catches invalid rule IDs
- Test validation warns on deprecated fields
- Test CLI schema command
- Test config auto-discovery

---

### Step 11: Update documentation

**Goal**: Document the new features

**Files**:
- `README.md` - Add schema section
- `SPEC.md` - Document validation rules

---

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| Breaking changes to config loading | Make validation opt-in (warnings, not errors for existing configs) |
| Schema drift from code | Add CI check to verify schema is current |
| TOML vs JSON schema mismatch | JSON schema works for TOML in most editors; document recommended extensions |

## Complexity

- **Overall**: Medium
- **Confidence**: High
- **Reasoning**: Builds on existing patterns (schemars in agnix-mcp). Additive functionality, no architectural changes.
